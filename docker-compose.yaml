services:
  zypi-node:
    build:
      context: .
      dockerfile: Dockerfile
    image: zypi:latest
    container_name: zypi-node
    cgroup: host
    privileged: true
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN
    devices:
      - /dev/kvm:/dev/kvm
      - /dev/net/tun:/dev/net/tun
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
      - ./.zypi/registry:/mnt/zypi-registry
      - ./.zypi/data:/var/lib/zypi
      # OverlayBD mounts:
      - ./.zypi/overlaybd:/mnt/zypi-overlaybd
      - ./.zypi/overlaybd/images:/var/lib/overlaybd
      # Replace internal config with yours
      - ./config/overlaybd.json:/etc/overlaybd/overlaybd.json:ro
      # (Optional, but recommended)
      - /dev:/dev
      # mount elixir source code
      - ./lib:/app/lib
      - ./config:/app/config
      # guest agent binary
      - ./guest-agent/zypi-agent:/opt/zypi/bin/zypi-agent
    environment:
      - ZYPI_DATA_DIR=/var/lib/zypi
      - ZYPI_KERNEL_PATH=/opt/zypi/kernel/vmlinux
      - ZYPI_LOG_LEVEL=debug
      - MIX_ENV=dev
    ports:
      - "4000:4000"   # API
      - "4001:4001"   # Console socket
    networks:
      - zypi_net

networks:
  zypi_net:
    driver: bridge